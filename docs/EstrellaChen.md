# Student Bay 后端搭建报告

## 一、项目概述

我是本次 Student Bay 项目的后端开发成员。Student Bay 是一个面向大学校园社区的二手物品交易平台，需要实现用户注册验证、物品发布、搜索发现、交易管理等核心功能。本报告将详细说明我在后端搭建过程中的工作内容、技术选型、实现细节以及遇到的问题和解决方案。

## 二、技术选型与架构设计

### 2.1 技术栈选择

在项目初期，我根据需求文档和项目规模，选择了以下技术栈：

- **运行环境**：Node.js
- **Web 框架**：Express.js
- **数据库**：SQLite

### 2.2 项目结构设计

我设计了清晰的项目结构，将代码按功能模块化组织：

```
back-end/
├── index.js              # Express 服务器主文件
├── package.json          # 项目配置和依赖
├── routes/               # API 路由
│   ├── users.js         # 用户相关路由
│   ├── items.js         # 物品相关路由
│   └── upload.js        # 图片上传路由
├── middleware/          # 中间件
│   ├── auth.js          # JWT 认证中间件
│   └── validation.js    # 数据验证中间件
├── utils/               # 工具模块
│   └── fieldConverter.js # 字段名称转换工具
└── db/                  # 数据库
    └── database.js      # 数据库连接和初始化
```

这种结构的好处是：
- **职责分离**：每个模块专注于特定功能
- **易于维护**：代码组织清晰，便于后续修改和扩展
- **可复用性**：中间件和工具函数可以在多个路由中复用

## 三、核心功能实现

### 3.1 数据库设计与初始化

我设计了 5 个核心数据表来支撑系统功能：

1. **users 表**：存储用户信息，包括邮箱、密码哈希、会员类型、验证状态等
2. **items 表**：存储物品信息，支持 5 个类别的特定字段（教材、电子产品、家具、服装、体育器材）
3. **ratings 表**：存储用户评分记录
4. **watchlists 表**：存储用户关注列表
5. **item_status_history 表**：记录物品状态变更历史

数据库初始化采用 Promise 链式调用，确保表按顺序创建，并启用了外键约束以保证数据完整性。我还实现了动态列检查机制，如果表已存在但缺少某些列，会自动添加，这样可以在不丢失数据的情况下升级数据库结构。

### 3.2 用户认证系统

我实现了基于 JWT（JSON Web Token）的认证系统：

- **用户注册**：支持学生会员（STUDENT）和关联会员（ASSOCIATE）两种类型，使用 bcryptjs 对密码进行哈希加密存储
- **邮箱验证**：学生会员和关联会员必须使用大学邮箱（.edu 域名），注册后生成验证令牌，通过邮件验证流程解锁交易权限
- **登录认证**：登录成功后生成 JWT Token，有效期 7 天
- **权限控制**：实现了 `authenticateToken` 中间件用于必需认证的路由，`optionalAuth` 中间件用于可选认证的路由，`requireMemberType` 用于检查特定会员类型权限

### 3.3 物品管理系统

物品管理是系统的核心功能之一，我实现了以下特性：

- **物品发布**：支持上传最多 5 张图片，填写标题、描述、价格、状况等基本信息
- **类别特定字段**：根据物品类别（教材、电子产品、家具、服装、体育器材）动态保存对应的特定字段，如教材的 ISBN、课程代码、模块名等
- **物品搜索**：实现了多条件搜索功能，支持关键词、分类、价格区间、状况筛选，以及排序和分页
- **物品状态管理**：支持 Available、Reserved、Sold 三种状态，卖家可以更新物品状态
- **浏览量统计**：每次查看物品详情时自动增加浏览量

### 3.4 图片上传功能

使用 multer 中间件实现图片上传功能：

- 支持头像和物品图片两种类型
- 文件大小限制为 5MB
- 只允许上传图片格式（jpg、jpeg、png、gif）
- 自动生成唯一文件名，避免文件名冲突
- 上传的图片存储在 `uploads` 目录，通过 Express 静态文件服务提供访问

### 3.5 数据格式转换

由于前端使用 camelCase 命名（如 `postDate`），而后端数据库使用 snake_case 命名（如 `post_date`），我开发了 `fieldConverter.js` 工具模块，自动处理前后端之间的字段格式转换，无需在业务代码中手动转换。

## 四、安全特性实现

在安全方面，我实现了以下措施：

1. **密码加密**：使用 bcryptjs 进行密码哈希，不存储明文密码
2. **JWT 认证**：使用 jsonwebtoken 进行身份认证，Token 包含用户 ID 和会员类型信息
3. **输入验证**：所有 API 端点都包含数据验证，防止无效数据提交
4. **SQL 注入防护**：使用参数化查询，避免 SQL 注入攻击
5. **CORS 配置**：限制允许的前端域名，防止跨域攻击
6. **密码复杂度**：要求密码至少 8 位，必须包含字母和数字
7. **邮箱验证**：学生会员和关联会员需要大学邮箱（.edu 域名）验证

## 五、前后端整合

为了简化部署和开发，我将前后端整合到同一个 Express 服务器：

- **静态文件服务**：Express 提供前端 HTML/CSS/JS 文件服务
- **API 服务**：Express 提供 RESTful API 接口
- **统一端口**：所有请求都通过 8080 端口访问
- **SPA 支持**：非 API 请求自动返回前端首页，支持前端路由

这种架构的优势是：
- 简化部署：只需启动一个服务器
- 同源访问：无需配置复杂的 CORS，减少跨域问题
- 统一管理：前后端代码在同一项目中，便于管理
- 开发便捷：一个命令启动完整应用

但同时，我也保持了前后端在文件结构上的分离，以便审阅

## 六、开发过程中的挑战与解决

### 6.1 数据库字段扩展问题

在开发过程中，我发现需要在已存在的 items 表中添加新的类别特定字段。如果直接修改表结构，可能会丢失已有数据。我通过实现 `ensureColumnExists` 函数，在数据库初始化时检查列是否存在，如果不存在则自动添加，这样可以在不丢失数据的情况下升级数据库结构。

### 6.2 字段命名不一致问题

前端使用 camelCase，后端数据库使用 snake_case，如果手动转换会非常繁琐且容易出错。我开发了 `fieldConverter.js` 工具模块，自动处理字段名称的双向转换，大大简化了开发工作。

### 6.3 图片上传路径问题

最初图片上传后，前端无法正确访问。我通过配置 Express 静态文件服务，将 `uploads` 目录映射到 `/uploads` 路径，解决了图片访问问题。

### 6.4 环境变量配置

服务器启动时需要 JWT_SECRET 等环境变量，如果未配置会导致启动失败。我在 `index.js` 中添加了环境变量检查，如果缺少必需的环境变量，会给出明确的错误提示，帮助开发者快速定位问题。

## 七、AI 辅助使用说明

在开发过程中，我使用了 AI 工具（ChatGPT/Cursor）辅助以下工作：

1. **需求检查**：使用 AI 帮助我检查需求文档，确保理解所有功能要求，特别是类别特定字段、会员类型权限等复杂需求
2. **错误排查**：当遇到代码错误时，我会将错误信息提供给 AI，帮助我快速定位问题原因，例如数据库连接错误、JWT 验证失败等
3. **符合度判断**：使用 AI 帮助我对照需求文档，判断已实现功能与任务要求的符合程度，识别缺失的功能点，例如发现缺少 Public Member 角色、评分写入 API 等

除了上述使用 AI 进行需求检查、错误排查和符合度判断外，所有的代码编写、架构设计、数据库设计、功能实现、测试等工作均由我独立完成。AI 仅作为辅助工具帮助我理解需求和排查问题，核心开发工作完全由我自己完成。

## 八、API 接口设计

我设计了 RESTful 风格的 API 接口：

### 用户相关 API
- `POST /api/users/register` - 用户注册
- `POST /api/users/login` - 用户登录
- `GET /api/users/me` - 获取当前用户信息
- `GET /api/users/profile` - 获取用户资料
- `PUT /api/users/profile` - 更新用户资料
- `POST /api/users/verification/send` - 发送验证邮件
- `POST /api/users/verification/verify` - 验证邮箱

### 物品相关 API
- `GET /api/items/search` - 搜索物品
- `GET /api/items` - 获取物品列表
- `GET /api/items/:id` - 获取物品详情
- `GET /api/items/my` - 获取当前用户的物品列表
- `POST /api/items` - 发布物品
- `PUT /api/items/:id` - 更新物品
- `PUT /api/items/:id/status` - 更新物品状态
- `DELETE /api/items/:id` - 删除物品

### 图片上传 API
- `POST /api/upload/image` - 上传图片

所有 API 都遵循统一的响应格式：
```json
{
  "success": true/false,
  "message": "操作结果消息",
  "data": {...}
}
```

## 九、测试与验证

在开发过程中，我通过以下方式测试后端功能：

1. **单元测试**：使用 Postman 和 curl 命令测试各个 API 端点
2. **集成测试**：与前端联调，确保前后端数据交互正常
3. **边界测试**：测试各种边界情况，如空数据、超长字符串、无效格式等
4. **安全测试**：验证 JWT 认证、密码加密、输入验证等安全特性

## 十、项目总结

通过本次后端开发，我深入学习了 Node.js 和 Express.js 框架，掌握了 RESTful API 设计、JWT 认证、数据库设计等后端开发技能。项目实现了用户认证、物品管理、搜索等核心功能，基本满足了需求文档的要求。

虽然还有一些功能需要完善（如 Public Member 角色、完整的评分系统、关注列表 API、邮件通知等），但核心功能已经实现并可以正常运行。通过这次项目，我不仅提升了技术能力，也学会了如何设计可扩展、易维护的系统架构。

## 十一、后续改进方向

1. **交易系统**：现在商品只能被查看，没有交易系统完成交易
2. **买家评论**：买家可以对商品做出评价，但现在只在前端由展示页面，后端无实现
3. **联系卖家**：现在联系卖家只存在按钮，无实际作用，需要完成用户沟通模块才能运作
4. **订阅功能**：完善订阅关注商品功能，现在此功能只能点击，不能工作

---

**报告完成时间**：2025年11月27日

**开发者**：Estrella Chen

